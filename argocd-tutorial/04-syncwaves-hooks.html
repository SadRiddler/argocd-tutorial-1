<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SyncWaves and Hooks :: ArgoCD Tutorial</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/argocd-tutorial/04-syncwaves-hooks.html">
    <link rel="prev" href="03-kustomize.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://redhat-scholars.github.io/course-template">ArgoCD Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="argocd-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">ArgoCD Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#kubernetes">Setup Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#install_argocd">Install ArgoCD</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-getting_started.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-getting_started.html#connect_argocd">Connecting to ArgoCD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-getting_started.html#deploy_sample_application">Deploying Sample Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-kustomize.html">Work with Kustomize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-kustomize.html#exploring_kustomize">Exploring the Kustomize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-kustomize.html#exploring_kustomize_cli">Exploring the Kustomize CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-kustomize.html#exploring_kustomize_with_kubectl">Exploring Kustomize with Kubectl</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-kustomize.html#deploying_kustomized_application">Deploying Kustomized Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-kustomize.html#argocd_web_console">The ArgoCD Web Console</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-kustomize.html#kustomized_application">Kustomized Application</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-syncwaves-hooks.html">Sync Waves and Hooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#using_syncwaves">Using Sync Waves</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#exploring_the_manifests">Exploring the Manifests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deploying_the_application">Deploying the Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#exploring_resource_hooks">Exploring Resource Hooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#exploring_the_manifests_hooks">Exploring the Manifests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deploying_the_application_hooks">Deploying the Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#using_syncwaves_and_hooks">Using Sync Waves and Hooks</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#exploring_the_manifests_resources">Exploring the Manifests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deploying_application_resources">Deploying the Application</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ArgoCD Tutorial</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ArgoCD Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">ArgoCD Tutorial</a></li>
    <li><a href="04-syncwaves-hooks.html">Sync Waves and Hooks</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/argocd-tutorial/edit/master/documentation/modules/ROOT/pages/04-syncwaves-hooks.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">SyncWaves and Hooks</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://argoproj.github.io/argo-cd/user-guide/sync-waves/" target="_blank" rel="noopener">Syncwaves</a> are used in Argo CD to order how manifests are applied to the cluster.</p>
</div>
<div class="paragraph">
<p>On the other hand <a href="https://argoproj.github.io/argo-cd/user-guide/resource_hooks/" target="_blank" rel="noopener">resource hooks</a> breaks up the delivery of these manifests in different phases.</p>
</div>
<div class="paragraph">
<p>Using a combination of syncwaves and resource hooks, you can control how your application rolls out.</p>
</div>
<div class="paragraph">
<p>This example will take you through the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using Syncwaves to order deployment</p>
</li>
<li>
<p>Exploring Resource Hooks</p>
</li>
<li>
<p>Using Syncwaves and Hooks together</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using_syncwaves"><a class="anchor" href="#using_syncwaves"></a>Using Sync Waves</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Syncwave is a way to order how Argo CD applies the manifests that are stored in git. All manifests have a wave of zero by default, but you can set these by using the <code>argocd.argoproj.io/sync-wave</code> annotation.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "2"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The wave can also be negative as well.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "-5"</code></pre>
</div>
</div>
<div class="paragraph">
<p>When Argo CD starts a sync action, the manifest get placed in the following order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Phase that they&#8217;re in (we&#8217;ll cover phases in the next section)</p>
</li>
<li>
<p>The wave the resource is annotated in (starting from the lowest value to the highest)</p>
</li>
<li>
<p>By kind (Namspaces first, then services, then deployments, etc &#8230;&#8203;)</p>
</li>
<li>
<p>By name (ascending order)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Read more about syncwaves on the <a href="https://argoproj.github.io/argo-cd/user-guide/sync-waves/#how-do-i-configure-waves" target="_blank" rel="noopener">official documentation site</a>.</p>
</div>
<div class="sect2">
<h3 id="exploring_the_manifests"><a class="anchor" href="#exploring_the_manifests"></a>Exploring the Manifests</h3>
<div class="paragraph">
<p>The sample application that we will deploy has the following manifests:</p>
</div>
<div class="paragraph">
<p>The <strong>Namespace</strong> with syncwave as <strong>0</strong>:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/blob/main/apps/welcome-php/overlays/syncwaves/welcome-php-ns.yaml" target="_blank" rel="noopener">welcome-php-ns.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  name: welcome
spec: {}
status: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>Deployment</strong> with syncwave as <strong>1</strong>:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/blob/main/apps/welcome-php/base/welcome-php-deployment.yaml" target="_blank" rel="noopener">welcome-php-deployment.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app: welcome-php
  name: welcome-php
spec:
  replicas: 1
  selector:
    matchLabels:
      app: welcome-php
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: welcome-php
    spec:
      containers:
      - image: quay.io/redhatworkshops/welcome-php:latest
        name: welcome-php
        resources: {}
status: {}</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset1_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_minikube">
<div class="paragraph">
<p>The <strong>Service</strong> with syncwave as <strong>2</strong>:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/blob/minikube/apps/welcome-php/base/welcome-php-svc.yaml" target="_blank" rel="noopener">welcome-php-svc.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "2"
  labels:
    app: welcome-php
  name: welcome-php
spec:
  type: NodePort
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: welcome-php</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>Ingress</strong> with syncwave as <strong>3</strong>:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/blob/minikube/apps/welcome-php/base/welcome-php-ingress.yaml" target="_blank" rel="noopener">welcome-php-ingress.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: welcome-php
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  rules:
    - host: welcome-php.devnation
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: welcome-php
                port:
                  number: 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add Minikube IP (<code>minikube ip</code>) and the Ingress hostname <code>welcome-php.devnation</code> to your Host file, like <code>/etc/hosts</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">192.168.39.242 bgd.devnation bgdx.devnation welcome-php.devnation</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_openshift">
<div class="paragraph">
<p>The <strong>Service</strong> with syncwave as <strong>2</strong>:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/blob/main/apps/welcome-php/base/welcome-php-svc.yaml" target="_blank" rel="noopener">welcome-php-svc.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "2"
  labels:
    app: welcome-php
  name: welcome-php
spec:
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: welcome-php
status:
  loadBalancer: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>Route</strong> with syncwave as <strong>3</strong>:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/blob/main/apps/welcome-php/base/welcome-php-route.yaml" target="_blank" rel="noopener">welcome-php-route.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: route.openshift.io/v1
kind: Route
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "3"
  labels:
    app: welcome-php
  name: welcome-php
spec:
  port:
    targetPort: 8080
  to:
    kind: Service
    name: welcome-php
    weight: null
status: {}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Argo CD will apply the Namespace first (since it&#8217;s the lowest value), and make sure it returns a "healthy" status before moving on.</p>
</div>
<div class="paragraph">
<p>Next, the Deployment will be applied. After that reports healthy, Argo CD will apply the Service then the Ingress or Route.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Argo CD won&#8217;t apply the next manifest until the previous reports "healthy".
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="deploying_the_application"><a class="anchor" href="#deploying_the_application"></a>Deploying the Application</h3>
<div class="paragraph">
<p>Before we deploy this application, make sure you&#8217;ve opened the Argo CD Web Console.</p>
</div>
<div class="paragraph">
<p>Access to the Arg2oCD console with the user admin and the password extracted in the previous steps:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd-login.png" alt="ArgoCDLogin" width="600">
</div>
</div>
<div class="paragraph">
<p>Apply the Argo CD <code>Application</code> manifest to get this application deployed.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset2_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_minikube">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f documentation/modules/ROOT/examples/minikube/syncwaves-hooks/welcome-syncwaves.yaml</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_openshift">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f documentation/modules/ROOT/examples/syncwaves-hooks/welcome-syncwaves.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">application.argoproj.io/welcome-syncwaves created</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should create the <code>welcome-syncwaves</code> in the ArgoCD UI.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/welcome-syncwaves.png" alt="Syncwaves1" width="400">
</div>
</div>
<div class="paragraph">
<p>Clicking on this "card" will take you to the application overview page. Clicking on "show hidden resources" should expand the "tree" view.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/welcome-syncwaves-tree.png" alt="Syncwaves2" width="400">
</div>
</div>
<div class="paragraph">
<p>If you follow along, you&#8217;ll note that these manifests get applied in order of their annotated syncwave!</p>
</div>
<div class="paragraph">
<p>Keep the Argo CD WebUI tab open for the next exercise.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exploring_resource_hooks"><a class="anchor" href="#exploring_resource_hooks"></a>Exploring Resource Hooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you&#8217;re familiar with syncwaves, we can begin exploring applying
manifests in phases using <code>resource hooks</code>.</p>
</div>
<div class="paragraph">
<p>Controlling your sync operation can be futher redefined by using
hooks. These hooks can run before, during, and after a sync
operation. These hooks are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>PreSync</strong> - Runs before the sync operation. This can be something like a database backup before a schema change</p>
</li>
<li>
<p><strong>Sync</strong> - Runs after <code>PreSync</code> has successfully ran. This will run alongside your normal manifesets.</p>
</li>
<li>
<p><strong>PostSync</strong> - Runs after <code>Sync</code> has ran successfully. This can be something like a Slack message or an email notification.</p>
</li>
<li>
<p><strong>SyncFail</strong> - Runs if the <code>Sync</code> operation as failed. This is also used to send notifications or do other evasive actions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable a sync, annotate the specific object manfiest with
<code>argocd.argoproj.io/hook</code> with the type of sync you want to use for that
resource. For example, if I wanted to use the <code>PreSync</code> hook:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">metadata:
  annotations:
    argocd.argoproj.io/hook: PreSync</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also have the hooks be deleted after a successful/unsuccessful run.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>HookSucceeded</strong> - The resouce will be deleted after it has succeeded.</p>
</li>
<li>
<p><strong>HookFailed</strong> - The resource will be deleted if it has failed.</p>
</li>
<li>
<p><strong>BeforeHookCreation</strong> - The resource will be deleted before a new one is created (when a new sync is triggered).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can apply these with the <code>argocd.argoproj.io/hook-delete-policy</code>
annotation. For example</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">metadata:
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>NOTE</strong> Since a sync can fail in any phase, you can come to a situation where the application never reports healthy!</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Although hooks can be any resource, they are usually Pods and/or Jobs.</p>
</div>
<div class="paragraph">
<p>To read more about resource hooks, consult the <a href="https://argoproj.github.io/argo-cd/user-guide/resource_hooks">official documentation</a></p>
</div>
<div class="sect2">
<h3 id="exploring_the_manifests_hooks"><a class="anchor" href="#exploring_the_manifests_hooks"></a>Exploring Manifests</h3>
<div class="paragraph">
<p>Take a look at this <code>PreSync</code> manifest:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/argocd-tutorial/blob/master/documentation/modules/ROOT/examples/syncwaves-hooks/hooks/welcome-php-presync-job.yaml" target="_blank" rel="noopener">welcome-php-presync-job.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: batch/v1
kind: Job
metadata:
  creationTimestamp: null
  name: welcome-presyncjob
  annotations:
    argocd.argoproj.io/hook: PreSync <i class="conum" data-value="1"></i><b>(1)</b>
spec:
  template:
    metadata:
      creationTimestamp: null
    spec:
      containers:
      - command:
        - /bin/bash
        - -c
        - |
          sleep 15
        image: registry.access.redhat.com/ubi8/ubi:latest
        imagePullPolicy: IfNotPresent
        name: welcome-sleep-job
      restartPolicy: Never</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This means that this Job will run in the <code>PreSync</code> phase, before
the application of the manifests in the <code>Sync</code> phase.</td>
</tr>
</table>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>NOTE</strong> Since I don&#8217;t have a deletion policy, this job will "stick around" after completion.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="deploying_the_application_hooks"><a class="anchor" href="#deploying_the_application_hooks"></a>Deploying The Application</h3>
<div class="paragraph">
<p>This sample will be using <code>kustomize</code> to create a new application based
on the one we previously deployed; while adding the <code>Job</code>
with the resource hook. You can see this by <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/main/apps/welcome-php/overlays/hooks" target="_blank" rel="noopener">visiting the repo</a>.</p>
</div>
<div class="paragraph">
<p>Taking a look at this manifest file: <code>welcome-hooks.yaml</code>:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset3_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_minikube">
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/argocd-tutorial/blob/master/documentation/modules/ROOT/examples/minikube/syncwaves-hooks/welcome-hooks.yaml" target="_blank" rel="noopener">welcome-hooks.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: welcome-hooks
  namespace: argocd
spec:
  destination:
    namespace: welcome-hooks
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: default
  source:
    path: apps/welcome-php/overlays/hooks
    repoURL: <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples" class="bare">https://github.com/redhat-developer-demos/openshift-gitops-examples</a>
    targetRevision: minikube
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
    syncOptions:
    - CreateNamespace=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will show that this will deploy the application in the <code>welcome-hooks</code>
namespace.</p>
</div>
<div class="paragraph">
<p>Create this application:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f documentation/modules/ROOT/examples/minikube/syncwaves-hooks/welcome-hooks.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add Minikube IP (<code>minikube ip</code>) and the Ingress hostname <code>welcome-php-hooks.devnation</code> to your Host file, like <code>/etc/hosts</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">192.168.39.242 bgd.devnation bgdx.devnation welcome-php.devnation welcome-php-hooks.devantion</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_openshift">
<div class="listingblock">
<div class="title"><a href="https://github.com/redhat-scholars/argocd-tutorial/blob/master/documentation/modules/ROOT/examples/syncwaves-hooks/welcome-hooks.yaml" target="_blank" rel="noopener">welcome-hooks.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: welcome-hooks
  namespace: openshift-gitops
spec:
  destination:
    namespace: welcome-hooks
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: default
  source:
    path: apps/welcome-php/overlays/hooks
    repoURL: <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples" class="bare">https://github.com/redhat-developer-demos/openshift-gitops-examples</a>
    targetRevision: main
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
    syncOptions:
    - CreateNamespace=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will show that this will deploy the application in the <code>welcome-hooks</code>
namespace.</p>
</div>
<div class="paragraph">
<p>Create this application:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f documentation/modules/ROOT/examples/syncwaves-hooks/welcome-hooks.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">application.argoproj.io/welcome-hooks created</code></pre>
</div>
</div>
<div class="paragraph">
<p>On the Argo CD WebUI, you should see another application appear.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/hooks-card.png" alt="Hooks Card">
</div>
</div>
<div class="paragraph">
<p>Clicking on this "card" should take you over to the tree view.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/hooks-tree.png" alt="Hooks Tree">
</div>
</div>
<div class="paragraph">
<p>Observe the sync process. You will see that the <code>PreSync</code> manifest has
an anchor icon ⚓ . You will also notice that the other manifests don&#8217;t
start applying until the <code>PreSync</code> Job is done.</p>
</div>
<div class="paragraph">
<p>Once the application is fully synced. Take a look at the pods and jobs in
the namespace:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods,jobs -n welcome-hooks</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see that the Job is finished, but still there.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                               READY   STATUS      RESTARTS   AGE
pod/welcome-php-6986bd99c4-7w7qk   1/1     Running     0          2m43s
pod/welcome-presyncjob-l9h8n       0/1     Completed   0          3m14s

NAME                           COMPLETIONS   DURATION   AGE
job.batch/welcome-presyncjob   1/1           30s        3m14s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Keep this tab open, in the next exercise. We will see how to use Syncwaves
and Hooks in tandem!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using_syncwaves_and_hooks"><a class="anchor" href="#using_syncwaves_and_hooks"></a>Using Sync Waves and Hooks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you got your hands on syncwaves and resource hooks, you will
now use them together to see how you can control how your deployment
rolls out.</p>
</div>
<div class="paragraph">
<p>In the previous sections you learned how to order the application
of manifests using syncwaves. You also went over how you phase your
deployments with resource hooks.</p>
</div>
<div class="paragraph">
<p>In this section we will use syncwaves within each phase to show how you
can further refine the deployment process.</p>
</div>
<div class="paragraph">
<p>Take a look at the following diagram.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/resource-hooks.png" alt="Resource waves hooks">
</div>
</div>
<div class="paragraph">
<p>The workflow can be summarized like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>PreSync</code> phase will run and manifests will be applied in their syncwave order.</p>
</li>
<li>
<p>Once the <code>PreSync</code> phase is successful, the <code>Sync</code> phase begins.</p>
</li>
<li>
<p>The <code>Sync</code> phase will apply the manifests in the their syncwave order</p>
</li>
<li>
<p>Finally, after the <code>Sync</code> phase is done, the <code>PostSync</code> phase applies the manifests in the syncwave order.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="exploring_manifests_resources"><a class="anchor" href="#exploring_manifests_resources"></a>Exploring Manifests</h3>
<div class="paragraph">
<p>Here we are adding 3 addition manifests.</p>
</div>
<div class="paragraph">
<p>A <strong>PreSync</strong> Job with a syncwave of <strong>0</strong>:</p>
</div>
<div class="listingblock">
<div class="title"><a href="" target="_blank" rel="noopener">welcome-php-presync-job.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: batch/v1
kind: Job
metadata:
  creationTimestamp: null
  name: welcome-presyncjob
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/sync-wave: "0"
spec:
  template:
    metadata:
      creationTimestamp: null
    spec:
      containers:
      - command:
        - /bin/bash
        - -c
        - |
          sleep 15
        image: registry.access.redhat.com/ubi8/ubi:latest
        imagePullPolicy: IfNotPresent
        name: welcome-sleep-job
      restartPolicy: Never</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <strong>PreSync</strong> Job with a syncwave of <strong>1</strong> and a hook deletion policy:</p>
</div>
<div class="listingblock">
<div class="title"><a href="" target="_blank" rel="noopener">welcome-php-presync-pod.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  name: welcome-presync-pod
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "1"
spec:
  containers:
  - command:
    - /bin/bash
    - -c
    - |
      echo "Pre deployment tasks"
      sleep 10
    image: registry.access.redhat.com/ubi8/ubi:latest
    imagePullPolicy: IfNotPresent
    name: welcome-sleep-pod
  dnsPolicy: ClusterFirst
  restartPolicy: Never</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <strong>PostSync</strong> Pod with a hook deletion policy:</p>
</div>
<div class="listingblock">
<div class="title"><a href="" target="_blank" rel="noopener">welcome-php-postsync-pod.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  name: welcome-postsync-pod
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  containers:
  - command:
    - /bin/bash
    - -c
    - |
      echo "Post deployment work"
      sleep 10
    image: registry.access.redhat.com/ubi8/ubi:latest
    imagePullPolicy: IfNotPresent
    name: welcome-sleep-pod
  dnsPolicy: ClusterFirst
  restartPolicy: Never</code></pre>
</div>
</div>
<div class="paragraph">
<p>The manifest will apply in the following order.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PreSync</code> - The Job will start and finish. The the Pod will start and finish. Once these are both done successfully the <code>PreSync</code> phase is considered "done".</p>
</li>
<li>
<p><code>Sync</code> - All the manifests will apply in their respective syncwave order. Once this is done successfully, the <code>Sync</code> phase is considered done.</p>
</li>
<li>
<p><code>PostSync</code> - The Pod will start and finish. Once it&#8217;s successfully finished, the resource is deleted.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="deploying_the_application_resources"><a class="anchor" href="#deploying_the_application_resources"></a>Deploying the Application</h3>
<div class="paragraph">
<p>Take a look at the manifest file:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_minikube"></a>Minikube</p>
</li>
<li>
<p><a id="tabset4_openshift"></a>OpenShift</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_minikube">
<div class="listingblock">
<div class="title"><a href="" target="_blank" rel="noopener">welcome-syncwaves-and-hooks.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: welcome-syncwaves-hooks
  namespace: argocd
spec:
  destination:
    namespace: welcome-waves-and-hooks
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: default
  source:
    path: apps/welcome-php/overlays/syncwaves-and-hooks
    repoURL: <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples" class="bare">https://github.com/redhat-developer-demos/openshift-gitops-examples</a>
    targetRevision: minikube
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
    syncOptions:
    - CreateNamespace=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, we are using Kustomize to deploy the same application,
but in a different namespace and we are loading in the 3 additional
manifests. You can see the specific implementation in the <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/minikube/apps/welcome-php/overlays/syncwaves-and-hooks" target="_blank" rel="noopener">git repo</a></p>
</div>
<div class="paragraph">
<p>Create this application:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f documentation/modules/ROOT/examples/minikube/syncwaves-hooks/welcome-syncwaves-and-hooks.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add Minikube IP (<code>minikube ip</code>) and the Ingress hostname <code>welcome-php-waves-hooks.devnation</code> to your Host file, like <code>/etc/hosts</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">192.168.39.242 bgd.devnation bgdk.devnation welcome-php.devnation welcome-php-hooks.devantion welcome-php-waves-hooks.devantion</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_openshift">
<div class="listingblock">
<div class="title"><a href="" target="_blank" rel="noopener">welcome-syncwaves-and-hooks.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: welcome-syncwaves-hooks
  namespace: openshift-gitops
spec:
  destination:
    namespace: welcome-waves-and-hooks
    server: <a href="https://kubernetes.default.svc" class="bare">https://kubernetes.default.svc</a>
  project: default
  source:
    path: apps/welcome-php/overlays/syncwaves-and-hooks
    repoURL: <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples" class="bare">https://github.com/redhat-developer-demos/openshift-gitops-examples</a>
    targetRevision: main
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
    syncOptions:
    - CreateNamespace=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>As before, we are using Kustomize to deploy the same application,
but in a different namespace and we are loading in the 3 additional
manifests. You can see the specific implementation in the <a href="https://github.com/redhat-developer-demos/openshift-gitops-examples/tree/main/apps/welcome-php/overlays/syncwaves-and-hooks" target="_blank" rel="noopener">git repo</a></p>
</div>
<div class="paragraph">
<p>Create this application:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f  documentation/modules/ROOT/examples/syncwaves-hooks/welcome-syncwaves-and-hooks.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">application.argoproj.io/welcome-hooks created</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should create the 3rd application on Argo CD.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/waves-and-hooks-card.png" alt="Waves and Hooks card">
</div>
</div>
<div class="paragraph">
<p>Clicking on this card should take you to the tree view.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/waves-and-hooks-tree.png" alt="Waves and Hooks Tree">
</div>
</div>
<div class="paragraph">
<p>Here you can observe the sync process happening in the order
specified. You will also note that the <code>PreSync</code> Pod and the <code>PostSync</code>
pod were deleted after the sync process because of the deletion policy
annotation.</p>
</div>
<div class="paragraph">
<p>Take a look to verify:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods,jobs -n welcome-waves-and-hooks</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the following output.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                               READY   STATUS      RESTARTS   AGE
pod/welcome-php-6986bd99c4-vv499   1/1     Running     0          4m52s
pod/welcome-presyncjob-8jtqj       0/1     Completed   0          5m24s

NAME                           COMPLETIONS   DURATION   AGE
job.batch/welcome-presyncjob   1/1           18s        5m24s</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-kustomize.html" class="query-params-link">Work with Kustomize</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
